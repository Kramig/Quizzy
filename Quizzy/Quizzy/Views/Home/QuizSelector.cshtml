@{
    ViewData["Title"] = "Quiz Selector";
}

<div class="text-center">
    <div class="d-inline-block">
        <input class="user-options" type="text" placeholder="Search Quizzes" />
        <a>Only show your quizzes: </a>
        <input class="user-options" type="checkbox" placeholder="Search All Quizzes" />
        <button id="search-button" class="btn btn-primary user-options">Search Quizzes</button>
    </div>
    <div id="quizes-container"></div>
</div>

<script type="module">
    import { localStorageKeys, GetFromLocalStorage } from '/js/utils.js';

    let quizzes = [];

    function renderQuizzes() {
        const container = document.getElementById('quizes-container');
        container.innerHTML = '';
        console.log('rerender', quizzes);
        // TODO: render quizzes here
    }

    document. getElementById('search-button').addEventListener('click', () => {
        const searchText = getSearchText();
        if (isSearchingOnlyOwn()) {
            if (searchText) searchMyQuizzes(searchText);
            else getMyQuizzes();
        } else {
            if (searchText) searchQuizzes(searchText);
            else getAllQuizzes();
        }
	});

    function isSearchingOnlyOwn() {
        const checkbox = document.querySelector('.user-options[type="checkbox"]');
        return checkbox?.checked ?? false;
	}

    function getSearchText() {
        const input = document.querySelector('.user-options[type="text"]');
        return input?.value ?? '';
	}

    function getAllQuizzes() {
        fetch('@Url.Content("~/QuizSelector/GetAll")')
            .then(response => response.json())
            .then(data => {
                quizzes = data;
                renderQuizzes();
            })
            .catch(error => console.error('Error fetching quizzes:', error));
    }

    function getMyQuizzes() {
        const userId = GetFromLocalStorage(localStorageKeys.UserId);

        fetch(`@Url.Content("~/QuizSelector/GetAllById")?id=${encodeURIComponent(userId)}`)
            .then(response => response.json())
            .then(data => {
                quizzes = data;
                renderQuizzes();
            })
            .catch(error => console.error('Error fetching quizzes:', error));
    }

    function searchQuizzes(text) {
        fetch(`@Url.Content("~/QuizSelector/GetAllByName")?name=${encodeURIComponent(text)}`)
            .then(response => response.json())
            .then(data => {
                quizzes = data;
                renderQuizzes();
            })
            .catch(error => console.error('Error fetching quizzes:', error));
    }

    function searchMyQuizzes(text) {
        const userId = GetFromLocalStorage(localStorageKeys.UserId);

        fetch(`@Url.Content("~/QuizSelector/GetAllByIdAndName")?id=${encodeURIComponent(userId)}&name=${encodeURIComponent(text)}`)
            .then(response => response.json())
            .then(data => {
                quizzes = data;
                renderQuizzes();
            })
            .catch(error => console.error('Error fetching quizzes:', error));
    }

    // Optionally kick off initial load
    getAllQuizzes();
</script>

<style>
    .user-options {
        width: auto;
        min-width: 0;
        padding: 0.375rem 0.75rem;
        margin: 0 0.25rem 0.5rem 0.25rem 0.25rem;
        box-sizing: border-box;
        text-align: center;
        white-space: nowrap;
    }

    .btn {
        display: inline-block;
    }
</style>