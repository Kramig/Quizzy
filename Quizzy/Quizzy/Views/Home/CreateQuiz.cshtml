@model Quizzy.Core.DTOs.QuizCreatorModel

<button type="button" id="importJsonBtn">Import from JSON</button>
<input type="file" id="importJsonInput" accept=".json,application/json" style="display:none;" />
<br />
<label for="Title">Quiz Title:</label>
<input type="text" id="Title" name="Title" value="@Model.Title" />
<br />
<br />

<div id="questionsContainer">
    @for (int i = 0; i < Model.Questions.Count; i++)
    {
        var isMultiChoice = Model.Questions[i].Answers.Any(a => a.IsCorrect);
        <div class="question-block" style="position:relative;">
            <button type="button" class="remove-question-btn" title="Remove Question">&times;</button>
            <input type="text" name="Questions[@i].Text" value="@Model.Questions[i].Text" class="question-text" /><br /><br />
            <div class="answers" id="answers-@i">
                @for (int j = 0; j < Model.Questions[i].Answers.Count; j++)
                {
                    <div style="position:relative;">
                        <button type="button" class="remove-answer-btn" title="Remove Answer">&times;</button>
                        <input type="text" name="Questions[@i].Answers[@j].Text" value="@Model.Questions[i].Answers[j].Text" class="answer-text" />
                        @if (isMultiChoice)
                        {
                            <label>
                                <input type="checkbox" name="Questions[@i].Answers[@j].IsCorrect" value="true" @(Model.Questions[i].Answers[j].IsCorrect ? "checked" : "") class="answer-correct" />
                                Correct
                            </label>
                        }
                        <br />
                    </div>
                }
            </div>
            @if (isMultiChoice)
            {
                <button type="button" class="add-multichoice-answer-btn" data-qid="@i">Add answer</button>
            }
            else
            {
                <button type="button" class="add-short-answer-btn" data-qid="@i">Add answer</button>
            }
            <br /><br />
        </div>
    }
</div>

<div class="inline-block">
    <button id="addMultiChoiceQuestionButton" type="button">Add Multi-Choice Question</button>
    <button id="addShortAnswerQuestionButton" type="button">Add Short Answer Question</button>
</div>
<br />
<br />

<div class="save-options">
    @if (Model.QuizSourceId is not null)
    {
        <button id="updateBtn" type="button">Update Quiz</button>
    }
    <button id="createBtn" type="button">Save as New Quiz</button>
    <button id="exportJsonBtn" type="button">Download as JSON</button>
</div>

<input type="hidden" id="QuizSourceId" value="@Model.QuizSourceId" />
<script type="module">
    import { localStorageKeys, GetFromLocalStorage } from '/js/utils.js';

    let questionCount = @Model.Questions.Count;
    let answerCounts = [];
    @for (int i = 0; i < Model.Questions.Count; i++)
    {
            <text>answerCounts[@i] = @Model.Questions[i].Answers.Count;</text>
    }

    updateSaveButtonState();

    function updateSaveButtonState() {
        const createBtn = document.getElementById("createBtn");
        const jsonBtn = document.getElementById("exportJsonBtn");
        const updateBtn = document.getElementById("updateBtn");
        if (isQuizValid()) {
            createBtn.removeAttribute("disabled");
            jsonBtn.removeAttribute("disabled");
            if (updateBtn) updateBtn.removeAttribute("disabled");
        } else {
            createBtn.setAttribute("disabled", "disabled");
            jsonBtn.setAttribute("disabled", "disabled");
            if (updateBtn) updateBtn.setAttribute("disabled", "disabled");
        }
    }
    document.getElementById("Title").addEventListener("input", updateSaveButtonState);
    const container = document.getElementById("questionsContainer");

    const inputChangeHandler = (e) => {
        if (e.target.matches(".question-text, .answer-text, .answer-correct")) updateSaveButtonState();
    };
    container.addEventListener("input", inputChangeHandler);
    container.addEventListener("change", inputChangeHandler);

    container.addEventListener("click", (e) => {
        const removeQuestionBtn = e.target.closest(".remove-question-btn");
        if (removeQuestionBtn) {
            removeQuestion(removeQuestionBtn);
            return;
        }

        const removeAnswerBtn = e.target.closest(".remove-answer-btn");
        if (removeAnswerBtn) {
            removeAnswer(removeAnswerBtn);
            return;
        }

        const addMultichoiceAnswerBtn = e.target.closest(".add-multichoice-answer-btn");
        if (addMultichoiceAnswerBtn) {
            const qid = parseInt(addMultichoiceAnswerBtn.dataset.qid, 10);
            if (!Number.isNaN(qid)) addAnswer(qid, true);
            return;
        }

        const addShortAnswerBtn = e.target.closest(".add-short-answer-btn");
        if (addShortAnswerBtn) {
            const qid = parseInt(addShortAnswerBtn.dataset.qid, 10);
            if (!Number.isNaN(qid)) addAnswer(qid, false);
            return;
        }
    });

    document.getElementById("addMultiChoiceQuestionButton").addEventListener('click', () => addQuestion("multichoice"));
    document.getElementById("addShortAnswerQuestionButton").addEventListener('click', () => addQuestion("short"));
    document.getElementById("createBtn").addEventListener("click", () => saveQuiz(true));
    const updateBtnRef = document.getElementById("updateBtn");

    if (updateBtnRef) updateBtnRef.addEventListener("click", () => saveQuiz(false));
    document.getElementById("exportJsonBtn").addEventListener("click", downloadJSON);

    function addQuestion(answerType) {
        const qIdx = questionCount;
        answerCounts[qIdx] = 0;

        const questionDiv = document.createElement("div");
        questionDiv.className = "question-block";
        questionDiv.style.position = "relative";
        questionDiv.innerHTML = `
            <button type="button" class="remove-question-btn" title="Remove Question">&times;</button>
            <input type="text" name="Questions[${qIdx}].Text" class="question-text" /><br /><br />
            <div class="answers" id="answers-${qIdx}"></div>
            <button type="button" class="add-${answerType}-answer-btn" data-qid="${qIdx}">Add Answer</button><br /><br />
        `;
        container.appendChild(questionDiv);
        questionCount++;
        updateSaveButtonState();
    }

    function addAnswer(questionId, isMultiChoice) {
        if (typeof answerCounts[questionId] === "undefined") answerCounts[questionId] = 0;
        const answersDiv = document.getElementById(`answers-${questionId}`);
        const aIdx = answerCounts[questionId];

        const answerDiv = document.createElement("div");
        answerDiv.style.position = "relative";
        let newHtml = `<button type="button" class="remove-answer-btn" title="Remove Answer">&times;</button>
            <input type="text" name="Questions[${questionId}].Answers[${aIdx}].Text" class="answer-text" />`;
        if (isMultiChoice) {
            newHtml += `<label>
                <input type="checkbox" name="Questions[${questionId}].Answers[${aIdx}].IsCorrect" value="true" class="answer-correct" />
                Correct
            </label>`;
        }
        newHtml += `<br />`;

        answerDiv.innerHTML = newHtml;
        answersDiv.appendChild(answerDiv);
        answerCounts[questionId]++;
        updateSaveButtonState();
    }

    function saveQuiz(createNew) {
        if (isQuizValid()) {
             const quizData = getQuizDataFromPage();
             const uId = GetFromLocalStorage(localStorageKeys.UserId);
             if (!uId) { alert('Please sign in'); return; }

             fetch(`/QuizCreator/Create?uId=${encodeURIComponent(uId)}&createNew=${createNew}`, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(quizData)
             })
            .then(response => { if (!response.ok) Promise.reject(new Error("Save failed"))})
            .then(() => { alert('Quiz saved successfully!'); })
            .catch(error => { alert('Error saving quiz: ' + error.message); });
        } else alert("There are errors in the quiz. Please fix these before saving.");
    }

    function getQuizDataFromPage() {
        const quiz = {
            title: document.getElementById('Title').value,
            questions: []
        };

        const sourceId = document.getElementById('QuizSourceId')?.value;
        if (sourceId) {
            quiz.quizSourceId = sourceId;
        }

        const questionBlocks = document.querySelectorAll('.question-block');
        questionBlocks.forEach(qBlock => {
            const qText = qBlock.querySelector('.question-text').value;
            const answers = [];
            const answerTexts = qBlock.querySelectorAll('.answer-text');
            const answerChecks = qBlock.querySelectorAll('.answer-correct');
            answerTexts.forEach((aText, idx) => {
                const isCorrect = answerChecks[idx]?.checked ?? false;
                answers.push({
                    text: aText.value,
                    isCorrect: isCorrect
                });
            });
            quiz.questions.push({ text: qText, answers });
        });
        return quiz;
    }

    function isQuizValid() {
        const questions = document.querySelectorAll(".question-block");
        if (questions.length === 0) return false;
        for (let q of questions) {
            if (q.querySelector(".question-text").value.trim() === "") return false;

            const answers = q.querySelectorAll(".answer-text");
            if (answers.length === 0) return false;

            const hasCheckboxes = q.querySelectorAll(".answer-correct").length > 0;

            if (hasCheckboxes) {
                // Multi-choice rules: >= 2 answers and at least one correct
                if (answers.length < 2) return false;
                let hasCorrect = false;
                for (let i = 0; i < answers.length; i++) {
                    const answerText = answers[i].value.trim();
                    if (answerText === "") return false;
                    const isCorrect = q.querySelectorAll(".answer-correct")[i]?.checked ?? false;
                    if (isCorrect) hasCorrect = true;
                }
                if (!hasCorrect) return false;
            } else {
                for (let i = 0; i < answers.length; i++) {
                    const answerText = answers[i].value.trim();
                    if (answerText === "") return false;
                }
            }
        }
        return true;
    }

    function removeQuestion(btn) {
        const questionBlock = btn.closest('.question-block');
        questionBlock.remove();
        updateSaveButtonState();
    }

    function removeAnswer(btn) {
        const answerDiv = btn.parentElement;
        answerDiv.remove();
        updateSaveButtonState();
    }

    function downloadJSON() {
        const quizData = getQuizDataFromPage();
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(quizData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", (quizData.title || "quiz") + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    document.getElementById("importJsonBtn").addEventListener("click", function () {
        document.getElementById("importJsonInput").click();
    });

    document.getElementById("importJsonInput").addEventListener("change", function (event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const json = e.target.result;
            const encoded = encodeURIComponent(btoa(json));
            window.location.href = `/Home/CreateQuiz?import=${encoded}`;
        };
        reader.readAsText(file);
    });
</script>

<style>
    .remove-question-btn, .remove-answer-btn {
        position: absolute;
        left: -32px;
        top: 0;
        width: 28px;
        height: 28px;
        background: #e74c3c;
        color: #fff;
        border: none;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        z-index: 2;
        transition: background 0.2s;
    }

        .remove-question-btn:hover, .remove-answer-btn:hover {
            background: #c0392b;
        }

    .question-block, .answers > div {
        position: relative;
        padding-left: 36px;
    }

    .save-options {
        display: inline-block;
        margin-right: 10px;
    }
</style>